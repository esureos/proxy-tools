name: Update sing-box_ple
on:
  workflow_dispatch:
  schedule:
    - cron: "30 18 * * *"
  push:
    branches:
      - main
    paths-ignore:
      - "README.md"
      - ".github/workflows/delete-old-workflows.yml"
      - ".github/workflows/update-adguardhome.yml"
      - ".github/workflows/update-dashboard.yml"
      - ".github/workflows/update-mihomo.yml"
      - ".github/workflows/update-singbox.yml"

jobs:
  go:
    runs-on: ubuntu-latest
    outputs:
      go_version: ${{ steps.go.outputs.version }}
    steps:
      - name: Get `Go` latest version
        id: go
        run: |
          echo "version=$(curl -sSL https://raw.githubusercontent.com/actions/go-versions/update-versions-manifest-file/versions-manifest.json | jq -r '.[0].version')" >> $GITHUB_OUTPUT

  e5:
    runs-on: ubuntu-latest
    needs: go
    outputs:
      e5_version: ${{ steps.e5.outputs.e5_version }}
      e5_time: ${{ steps.e5.outputs.e5_time }}
      e5_tags: ${{ steps.e5.outputs.e5_tags }}
      e5_skip_update: ${{ steps.compare.outputs.skip_update }}
    steps:
      - name: Checkout `dev-next`
        uses: actions/checkout@v5
        with:
          repository: CHIZI-0618/sing-box
          ref: dev-next
          fetch-depth: 0

      - name: Setup `Go`
        uses: actions/setup-go@v6
        with:
          go-version: ${{ needs.go.outputs.go_version }}

      - name: Get `sing-box E5` version
        id: e5
        run: |
          git remote add sekai https://github.com/SagerNet/sing-box.git
          git fetch --tags sekai
          echo "e5_version=$(CGO_ENABLED=0 go run ./cmd/internal/read_tag)" >> $GITHUB_OUTPUT
          echo "e5_time=$(git log -1 --format=%cd --date=format:'%Y-%m-%d' $(echo "$e5_version" | awk -F '-' '{print $3}'))" >> $GITHUB_OUTPUT
          echo "e5_tags=with_quic,with_dhcp,with_gvisor,with_utls,with_clash_api,with_provider" >> $GITHUB_OUTPUT
          echo "CGO_ENABLED=0" >> $GITHUB_ENV
          echo "BUILDTAG=-extldflags -static" >> $GITHUB_ENV

      - name: Compare `sing-box E5` versions with current release
        id: compare
        run: |
          current_body=$(curl -sSL "https://api.github.com/repos/${{ github.repository }}/releases/tags/sing-box" | jq -r '.body // ""')
          if echo "$current_body" | grep -q "${{ steps.e5.outputs.e5_version }}.*${{ steps.e5.outputs.e5_time }}"; then
            echo "当前 sing-box E5 版本已是最新版本 ${{ steps.e5.outputs.e5_version }}，无需更新"
            skip_update=true
          else
            echo "当前 sing-box E5 版本较低，需要更新最新版本至 ${{ steps.e5.outputs.e5_version }}"
            skip_update=false
          fi
          echo "skip_update=$skip_update" >> $GITHUB_OUTPUT

  e5_cross:
    runs-on: ubuntu-latest
    if: ${{ needs.e5.outputs.e5_skip_update != 'true' }}
    strategy:
      matrix:
        include:
          # linux
          - { name: linux-amd64, goos: linux, goarch: amd64, goamd64: v3 }
          - { name: linux-armv5, goos: linux, goarch: arm, goarm: 5 }
          - { name: linux-armv6, goos: linux, goarch: arm, goarm: 6 }
          - { name: linux-armv7, goos: linux, goarch: arm, goarm: 7 }
          - { name: linux-arm64, goos: linux, goarch: arm64 }
          - { name: linux-mips-softfloat, goos: linux, goarch: mips, gomips: softfloat }
          - { name: linux-mipsle-softfloat, goos: linux, goarch: mipsle, gomips: softfloat }
          # windows
          - { name: windows-amd64, goos: windows, goarch: amd64, goamd64: v3 }
          - { name: windows-arm64, goos: windows, goarch: arm64 }
          # android
          - { name: android-arm, goos: android, goarch: arm, ndk: armv7a-linux-androideabi34 }
          - { name: android-arm64, goos: android, goarch: arm64, ndk: aarch64-linux-android34 }

      fail-fast: false
    needs:
      - go
      - e5
    env:
      GOOS: ${{ matrix.goos }}
      GOARCH: ${{ matrix.goarch }}
      GOAMD64: ${{ matrix.goamd64 }}
      GOARM: ${{ matrix.goarm }}
      GOMIPS: ${{ matrix.gomips }}
      e5_VERSION: ${{ needs.e5.outputs.e5_version }}
      e5_TAGS: ${{ needs.e5.outputs.e5_tags }}
    steps:
      - name: Checkout `dev-next`
        uses: actions/checkout@v5
        with:
          repository: CHIZI-0618/sing-box
          ref: dev-next

      - name: Setup `Go`
        uses: actions/setup-go@v6
        with:
          go-version: ${{ needs.go.outputs.go_version }}

      - name: Setup `NDK`
        if: ${{ matrix.goos == 'android' }}
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r28

      - name: Set `NDK` path
        if: ${{ matrix.goos == 'android' }}
        run: |
          echo "CC=${{steps.setup-ndk.outputs.ndk-path}}/toolchains/llvm/prebuilt/linux-x86_64/bin/${{matrix.ndk}}-clang" >> $GITHUB_ENV
          echo "CGO_ENABLED=1" >> $GITHUB_ENV
          echo "BUILDTAG=" >> $GITHUB_ENV

      - name: Build `sing-box E5` core
        id: build
        run: |
          echo "CGO_ENABLED=${CGO_ENABLED}"
          go build -v -trimpath -ldflags "${BUILDTAG} -checklinkname=0 -X 'github.com/sagernet/sing-box/constant.Version=${e5_VERSION}' -s -w -buildid=" -tags "${e5_TAGS}" ./cmd/sing-box

      - name: Upload files to workspace
        uses: actions/upload-artifact@v4
        with:
          name: sing-box-e5-${{ matrix.name }}
          path: sing-box*

  l5:
    runs-on: ubuntu-latest
    needs: go
    outputs:
      l5_version: ${{ steps.l5.outputs.l5_version }}
      l5_time: ${{ steps.l5.outputs.l5_time }}
      l5_tags: ${{ steps.l5.outputs.l5_tags }}
      l5_skip_update: ${{ steps.compare.outputs.skip_update }}
    steps:
      - name: Checkout `main-next`
        uses: actions/checkout@v5
        with:
          repository: lux5am/sing-box
          ref: main-next
          fetch-depth: 0

      - name: Setup `Go`
        uses: actions/setup-go@v6
        with:
          go-version: ${{ needs.go.outputs.go_version }}

      - name: Get `sing-box L5` version
        id: l5
        run: |
          git remote add sekai https://github.com/SagerNet/sing-box.git
          git fetch --tags sekai --force
          echo "l5_version=$(CGO_ENABLED=0 go run ./cmd/internal/read_tag)" >> $GITHUB_OUTPUT
          echo "l5_time=$(git log -1 --format=%cd --date=format:'%Y-%m-%d' $(echo "$l5_version" | awk -F '-' '{print $3}'))" >> $GITHUB_OUTPUT
          echo "l5_tags=with_gvisor,with_quic,with_dhcp,with_wireguard,with_utls,with_acme,with_clash_api,with_proxyproviders,with_urltest_fallback" >> $GITHUB_OUTPUT
          echo "CGO_ENABLED=0" >> $GITHUB_ENV
          echo "BUILDTAG=-extldflags -static" >> $GITHUB_ENV

      - name: Compare `sing-box L5` versions with current release
        id: compare
        run: |
          current_body=$(curl -sSL "https://api.github.com/repos/${{ github.repository }}/releases/tags/sing-box" | jq -r '.body // ""')
          if echo "$current_body" | grep -q "${{ steps.l5.outputs.l5_version }}.*${{ steps.l5.outputs.l5_time }}"; then
            echo "当前 sing-box L5 版本已是最新版本 ${{ steps.l5.outputs.l5_version }}，无需更新"
            skip_update=true
          else
            echo "当前 sing-box L5 版本较低，需要更新最新版本至 ${{ steps.l5.outputs.l5_version }}"
            skip_update=false
          fi
          echo "skip_update=$skip_update" >> $GITHUB_OUTPUT

  l5_cross:
    runs-on: ubuntu-latest
    if: ${{ needs.l5.outputs.l5_skip_update != 'true' }}
    strategy:
      matrix:
        include:
          # linux
          - { name: linux-amd64, goos: linux, goarch: amd64, goamd64: v3 }
          - { name: linux-armv5, goos: linux, goarch: arm, goarm: 5 }
          - { name: linux-armv6, goos: linux, goarch: arm, goarm: 6 }
          - { name: linux-armv7, goos: linux, goarch: arm, goarm: 7 }
          - { name: linux-arm64, goos: linux, goarch: arm64 }
          - { name: linux-mips-softfloat, goos: linux, goarch: mips, gomips: softfloat }
          - { name: linux-mipsle-softfloat, goos: linux, goarch: mipsle, gomips: softfloat }
          # windows
          - { name: windows-amd64, goos: windows, goarch: amd64, goamd64: v3 }
          - { name: windows-arm64, goos: windows, goarch: arm64 }
          # android
          - { name: android-arm, goos: android, goarch: arm, ndk: armv7a-linux-androideabi34 }
          - { name: android-arm64, goos: android, goarch: arm64, ndk: aarch64-linux-android34 }

      fail-fast: false
    needs:
      - go
      - l5
    env:
      GOOS: ${{ matrix.goos }}
      GOARCH: ${{ matrix.goarch }}
      GOAMD64: ${{ matrix.goamd64 }}
      GOARM: ${{ matrix.goarm }}
      GOMIPS: ${{ matrix.gomips }}
      l5_VERSION: ${{ needs.l5.outputs.l5_version }}
      l5_TAGS: ${{ needs.l5.outputs.l5_tags }}
    steps:
      - name: Checkout `main-next`
        uses: actions/checkout@v5
        with:
          repository: lux5am/sing-box
          ref: main-next

      - name: Setup `Go`
        uses: actions/setup-go@v6
        with:
          go-version: ${{ needs.go.outputs.go_version }}

      - name: Setup `NDK`
        if: ${{ matrix.goos == 'android' }}
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r28

      - name: Set `NDK` path
        if: ${{ matrix.goos == 'android' }}
        run: |
          echo "CC=${{steps.setup-ndk.outputs.ndk-path}}/toolchains/llvm/prebuilt/linux-x86_64/bin/${{matrix.ndk}}-clang" >> $GITHUB_ENV
          echo "CGO_ENABLED=1" >> $GITHUB_ENV
          echo "BUILDTAG=" >> $GITHUB_ENV

      - name: Build `sing-box L5` core
        id: build
        run: |
          echo "CGO_ENABLED=${CGO_ENABLED}"
          go build -v -trimpath -ldflags "${BUILDTAG} -checklinkname=0 -X 'github.com/sagernet/sing-box/constant.Version=${l5_VERSION}' -s -w -buildid=" -tags "${l5_TAGS}" ./cmd/sing-box

      - name: Upload files to workspace
        uses: actions/upload-artifact@v4
        with:
          name: sing-box-l5-${{ matrix.name }}
          path: sing-box*

  puernya:
    runs-on: ubuntu-latest
    needs: go
    outputs:
      puernya_version: ${{ steps.puernya.outputs.puernya_version }}
      puernya_time: ${{ steps.puernya.outputs.puernya_time }}
      puernya_tags: ${{ steps.puernya.outputs.puernya_tags }}
      puernya_skip_update: ${{ steps.compare.outputs.skip_update }}
    steps:
      - name: Checkout `building`
        uses: actions/checkout@v5
        with:
          repository: PuerNya/sing-box
          ref: building
          fetch-depth: 0

      - name: Setup `Go`
        uses: actions/setup-go@v6
        with:
          go-version: ${{ needs.go.outputs.go_version }}

      - name: Get `sing-box PuerNya` version
        id: puernya
        run: |
          git remote add sekai https://github.com/SagerNet/sing-box.git
          git fetch --tags sekai
          echo "puernya_version=$(CGO_ENABLED=0 go run ./cmd/internal/read_tag)" >> $GITHUB_OUTPUT
          echo "puernya_time=$(git log -1 --format=%cd --date=format:'%Y-%m-%d' $(echo "$puernya_version" | awk -F '-' '{print $3}'))" >> $GITHUB_OUTPUT
          echo "puernya_tags=with_quic,with_dhcp,with_wireguard,with_shadowsocksr,with_ech,with_utls,with_clash_api,with_gvisor" >> $GITHUB_OUTPUT
          echo "CGO_ENABLED=0" >> $GITHUB_ENV
          echo "BUILDTAG=-extldflags -static" >> $GITHUB_ENV

      - name: Compare `sing-box PuerNya` versions with current release
        id: compare
        run: |
          current_body=$(curl -sSL "https://api.github.com/repos/${{ github.repository }}/releases/tags/sing-box" | jq -r '.body // ""')
          if echo "$current_body" | grep -q "${{ steps.puernya.outputs.puernya_version }}.*${{ steps.puernya.outputs.puernya_time }}"; then
            echo "当前 sing-box PuerNya 版本已是最新版本 ${{ steps.puernya.outputs.puernya_version }}，无需更新"
            skip_update=true
          else
            echo "当前 sing-box PuerNya 版本较低，需要更新最新版本至 ${{ steps.puernya.outputs.puernya_version }}"
            skip_update=false
          fi
          echo "skip_update=$skip_update" >> $GITHUB_OUTPUT

  puernya_cross:
    runs-on: ubuntu-latest
    if: ${{ needs.puernya.outputs.puernya_skip_update != 'true' }}
    strategy:
      matrix:
        include:
          # linux
          - { name: linux-amd64, goos: linux, goarch: amd64, goamd64: v3 }
          - { name: linux-armv5, goos: linux, goarch: arm, goarm: 5 }
          - { name: linux-armv6, goos: linux, goarch: arm, goarm: 6 }
          - { name: linux-armv7, goos: linux, goarch: arm, goarm: 7 }
          - { name: linux-arm64, goos: linux, goarch: arm64 }
          - { name: linux-mips-softfloat, goos: linux, goarch: mips, gomips: softfloat }
          - { name: linux-mipsle-softfloat, goos: linux, goarch: mipsle, gomips: softfloat }
          # windows
          - { name: windows-amd64, goos: windows, goarch: amd64, goamd64: v3 }
          - { name: windows-arm64, goos: windows, goarch: arm64 }
          # android
          - { name: android-arm, goos: android, goarch: arm, ndk: armv7a-linux-androideabi34 }
          - { name: android-arm64, goos: android, goarch: arm64, ndk: aarch64-linux-android34 }

      fail-fast: false
    needs:
      - go
      - puernya
    env:
      GOOS: ${{ matrix.goos }}
      GOARCH: ${{ matrix.goarch }}
      GOAMD64: ${{ matrix.goamd64 }}
      GOARM: ${{ matrix.goarm }}
      GOMIPS: ${{ matrix.gomips }}
      puernya_VERSION: ${{ needs.puernya.outputs.puernya_version }}
      puernya_TAGS: ${{ needs.puernya.outputs.puernya_tags }}
    steps:
      - name: Checkout `building`
        uses: actions/checkout@v5
        with:
          repository: PuerNya/sing-box
          ref: building

      - name: Fix sniff
        run: sed -i 's/sniffHosts/sniffHost/' ./experimental/clashapi/trafficontrol/tracker.go

      - name: Setup `Go`
        uses: actions/setup-go@v6
        with:
          go-version: ${{ needs.go.outputs.go_version }}

      - name: Setup `NDK`
        if: ${{ matrix.goos == 'android' }}
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r28

      - name: Set `NDK` path
        if: ${{ matrix.goos == 'android' }}
        run: |
          echo "CC=${{steps.setup-ndk.outputs.ndk-path}}/toolchains/llvm/prebuilt/linux-x86_64/bin/${{matrix.ndk}}-clang" >> $GITHUB_ENV
          echo "CGO_ENABLED=1" >> $GITHUB_ENV
          echo "BUILDTAG=" >> $GITHUB_ENV

      - name: Build `sing-box PuerNya` core
        id: build
        run: |
          echo "CGO_ENABLED=${CGO_ENABLED}"
          go build -v -trimpath -ldflags "${BUILDTAG} -checklinkname=0 -X 'github.com/sagernet/sing-box/constant.Version=${puernya_VERSION}' -s -w -buildid=" -tags "${puernya_TAGS}" ./cmd/sing-box

      - name: Upload files to workspace
        uses: actions/upload-artifact@v4
        with:
          name: sing-box-puernya-${{ matrix.name }}
          path: sing-box*

  push_sing-box:
    runs-on: ubuntu-latest
    if: always()
    needs:
      - e5
      - e5_cross
      - l5
      - l5_cross
      - puernya
      - puernya_cross
    env:
      e5_VERSION: ${{ needs.e5.outputs.e5_version }}
      e5_TIME: ${{ needs.e5.outputs.e5_time }}
      l5_VERSION: ${{ needs.l5.outputs.l5_version }}
      l5_TIME: ${{ needs.l5.outputs.l5_time }}
      puernya_VERSION: ${{ needs.puernya.outputs.puernya_version }}
      puernya_TIME: ${{ needs.puernya.outputs.puernya_time }}
    steps:
      - name: Clone Repository
        uses: actions/checkout@v5

      - name: Download files from workspace
        uses: actions/download-artifact@v5
        with:
          path: ./tmp/

      - name: Move files and zip `sing-box E5` cores by `tar`
        if: ${{ needs.e5.outputs.e5_skip_update != 'true' }}
        run: |
          # Linux
          mkdir -p ./sing-box/
          old_name=(amd64 armv5 armv6 armv7 arm64 mips-softfloat mipsle-softfloat)
          new_name=(amd64 armv5 armv6 armv7 armv8 mips-softfloat mipsle-softfloat)
          for i in "${!old_name[@]}"; do
            mv -f "./tmp/sing-box-e5-linux-${old_name[i]}/sing-box" ./tmp/CrashCore
            chmod +x ./tmp/CrashCore
            tar --no-same-owner -czf "./sing-box/sing-box-e5-linux-${new_name[i]}.tar.gz" -C ./tmp/ CrashCore
          done

          # Windows
          archs=(amd64 arm64)
          for arch in "${archs[@]}"; do
            (cd "./tmp/sing-box-e5-windows-${arch}" && zip -r "../../sing-box/sing-box-e5-windows-${arch}.zip" sing-box.exe)
          done

          # Android
          archs=(arm arm64)
          for arch in "${archs[@]}"; do
            chmod +x "./tmp/sing-box-e5-android-${arch}/sing-box"
            tar --no-same-owner -czf "./sing-box/sing-box-e5-android-${arch}.tar.gz" -C "./tmp/sing-box-e5-android-${arch}" sing-box
          done

      - name: Move files and zip `sing-box L5` cores by `tar`
        if: ${{ needs.l5.outputs.l5_skip_update != 'true' }}
        run: |
          # Linux
          mkdir -p ./sing-box/
          old_name=(amd64 armv5 armv6 armv7 arm64 mips-softfloat mipsle-softfloat)
          new_name=(amd64 armv5 armv6 armv7 armv8 mips-softfloat mipsle-softfloat)
          for i in "${!old_name[@]}"; do
            mv -f "./tmp/sing-box-l5-linux-${old_name[i]}/sing-box" ./tmp/CrashCore
            chmod +x ./tmp/CrashCore
            tar --no-same-owner -czf "./sing-box/sing-box-l5-linux-${new_name[i]}.tar.gz" -C ./tmp/ CrashCore
          done

          # Windows
          archs=(amd64 arm64)
          for arch in "${archs[@]}"; do
            (cd "./tmp/sing-box-l5-windows-${arch}" && zip -r "../../sing-box/sing-box-l5-windows-${arch}.zip" sing-box.exe)
          done

          # Android
          archs=(arm arm64)
          for arch in "${archs[@]}"; do
            chmod +x "./tmp/sing-box-l5-android-${arch}/sing-box"
            tar --no-same-owner -czf "./sing-box/sing-box-l5-android-${arch}.tar.gz" -C "./tmp/sing-box-l5-android-${arch}" sing-box
          done

      - name: Move files and zip `sing-box PuerNya` cores by `tar`
        if: ${{ needs.puernya.outputs.puernya_skip_update != 'true' }}
        run: |
          # Linux
          mkdir -p ./sing-box/
          old_name=(amd64 armv5 armv6 armv7 arm64 mips-softfloat mipsle-softfloat)
          new_name=(amd64 armv5 armv6 armv7 armv8 mips-softfloat mipsle-softfloat)
          for i in "${!old_name[@]}"; do
            mv -f "./tmp/sing-box-puernya-linux-${old_name[i]}/sing-box" ./tmp/CrashCore
            chmod +x ./tmp/CrashCore
            tar --no-same-owner -czf "./sing-box/sing-box-puernya-linux-${new_name[i]}.tar.gz" -C ./tmp/ CrashCore
          done

          # Windows
          archs=(amd64 arm64)
          for arch in "${archs[@]}"; do
            (cd "./tmp/sing-box-puernya-windows-${arch}" && zip -r "../../sing-box/sing-box-puernya-windows-${arch}.zip" sing-box.exe)
          done

          # Android
          archs=(arm arm64)
          for arch in "${archs[@]}"; do
            chmod +x "./tmp/sing-box-puernya-android-${arch}/sing-box"
            tar --no-same-owner -czf "./sing-box/sing-box-puernya-android-${arch}.tar.gz" -C "./tmp/sing-box-puernya-android-${arch}" sing-box
          done
          rm -rf ./tmp*

      - name: Check if `sing-box` files exist
        id: check
        run: |
          if ls ./sing-box/* >/dev/null 2>&1; then
            echo "sing-box 文件夹内存在新内核文件，需要上传"
            echo "singbox_exist=true" >> $GITHUB_OUTPUT
          else
            echo "sing-box 文件夹内没有新内核文件，无需上传"
            echo "singbox_exist=false" >> $GITHUB_OUTPUT
          fi

      - name: Release and upload `sing-box` assets
        if: ${{ steps.check.outputs.singbox_exist == 'true' }}
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          release_name: sing-box_ple
          tag: sing-box_ple
          overwrite: true
          body: |
            更新 [sing-box E5 版](https://github.com/CHIZI-0618/sing-box/tree/dev-next)至 ${{ env.e5_VERSION }}，发布于 ${{ env.e5_TIME }}
            更新 [sing-box l5 版](https://github.com/lux5am/sing-box/tree/dev-next)至 ${{ env.l5_VERSION }}，发布于 ${{ env.l5_TIME }}
            更新 [sing-box PuerNya 版](https://github.com/PuerNya/sing-box/tree/building)至 v${{ env.puernya_VERSION }}，发布于 ${{ env.puernya_TIME }}
          file_glob: true
          file: ./sing-box/*
